<#@ template tier="20" #>
<Biml xmlns="http://schemas.varigence.com/biml.xsd">
	
	<Packages>
		
		<# foreach (var table in RootNode.Tables) { #>
			
			<Package Name="Load_<#=table.Schema#>_<#=table.Name#>" ConstraintMode="Linear">
			    
			    <Parameters>
			        <#@ include file="..\90-SharedUtilities\Audit-i-PackageParameters.biml" #>
			    </Parameters>
				
				<Variables>
					<#@ include file="..\90-SharedUtilities\Audit-i-PackageVariables.biml" #>
				</Variables>
				
				<Tasks>
				    
				    <#=CallBimlScript(@"..\90-SharedUtilities\Audit-c-LogPackageExecution.biml", "Start")#>
				
					<ExecuteSQL Name="Truncate <#=table.Schema#> <#=table.Name#>" ConnectionName="<#=table.Connection.Name#>">
						<DirectInput>TRUNCATE TABLE <#=table.Schema#>.<#=table.Name#></DirectInput>
					</ExecuteSQL>
					
					<Dataflow Name="Load <#=table.Schema#> <#=table.Name#>">
						<Transformations>

                            <OleDbSource Name="Source <#=table.GetTag("SourceConnection")#> <#=table.GetTag("SourceSchemaTableName")#>" ConnectionName="<#=table.GetTag("SourceConnection")#>">
								<DirectInput>SELECT <#=table.GetColumnList()#> FROM <#=table.GetTag("SourceSchemaQualifiedName")#>;</DirectInput>
							</OleDbSource>
							
				            <#=CallBimlScript(@"..\90-SharedUtilities\Audit-c-RowCount.biml", "New")#>
							
							<OleDbDestination Name="Destination <#=table.Schema#> <#=table.Name#>" ConnectionName="<#=table.Connection.Name#>">
								<ExternalTableOutput Table="<#=table.Schema#>.<#=table.Name#>" />
							</OleDbDestination>
						    
						</Transformations>
					</Dataflow>
					    
				    <#=CallBimlScript(@"..\90-SharedUtilities\Audit-c-LogPackageExecution.biml", "Stop")#>
				        
				</Tasks>
				
			    <#=CallBimlScript(@"..\90-SharedUtilities\Audit-c-LogPackageExecution.biml", "Error")#>
				
			</Package>
			
		<# } #>
			
	</Packages>
	
</Biml>